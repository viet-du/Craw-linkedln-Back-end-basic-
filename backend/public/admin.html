<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin</title>
  <style>/* giữ nguyên style cũ */</style>
</head>
<body>
  <div class="box">
    <h3>Admin - Users</h3>
    <div>
      <label>New username: <input id="newUser" /></label>
      <label>Password: <input id="newPass" type="password" /></label>
      <label>Role: <select id="newRole"><option value="user">user</option><option value="admin">admin</option></select></label>
      <button id="create">Create</button>
    </div>
    <h4>Existing users</h4>
    <table id="users"><thead><tr><th>Username</th><th>Role</th><th>Created</th><th>Action</th></tr></thead><tbody></tbody></table>
    <div style="margin-top:12px"><a href="/">Back</a></div>
  </div>

  <script src="/authInterceptor.js"></script>
  <script>
    // Kiểm tra quyền admin ngay khi vào trang
    const token = localStorage.getItem('token');
    if (!token) {
      window.location.href = '/login.html';
    } else {
      try {
        const payload = JSON.parse(atob(token.split('.')[1]));
        if (payload.role !== 'admin') {
          alert('You do not have permission to access this page.');
          window.location.href = '/';
        }
      } catch (e) {
        localStorage.removeItem('token');
        localStorage.removeItem('refreshToken');
        window.location.href = '/login.html';
      }
    }

    async function api(url, opts = {}) {
      const response = await authFetch(url, opts);
      return response.json();
    }

    async function load() {
      const j = await api('/api/admin/users');
      const tbody = document.querySelector('#users tbody');
      tbody.innerHTML = '';
      if (!j.success) {
        tbody.innerHTML = '<tr><td colspan="4">' + (j.error || 'error') + '</td></tr>';
        return;
      }
      j.data.forEach(u => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${u.username}</td><td>${u.role}</td><td>${new Date(u.createdAt).toLocaleString()}</td><td><button data-u='${u._id}'>Delete</button></td>`;
        tbody.appendChild(tr);
      });
      document.querySelectorAll('button[data-u]').forEach(b => {
        b.addEventListener('click', async e => {
          const id = e.target.getAttribute('data-u');
          await api('/api/admin/users/' + id, { method: 'DELETE' });
          load();
        });
      });
    }

    document.getElementById('create').addEventListener('click', async () => {
      const u = document.getElementById('newUser').value.trim();
      const p = document.getElementById('newPass').value;
      const r = document.getElementById('newRole').value;
      await api('/api/admin/users', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username: u, password: p, role: r })
      });
      load();
    });

    load();
  </script>
</body>
</html>